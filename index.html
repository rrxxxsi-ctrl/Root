import { useEffect, useMemo, useRef, useState } from "react";
import { faq } from "@/data/faq";
import { testimonials } from "@/data/testimonials";
import { IBAN, products, WHATSAPP_NUMBER, type Lang, type Product } from "@/data/products";
import { generateTrackingCode, migrateOrders } from "@/lib/orders";
import { getJSON, setJSON } from "@/lib/storage";
import type { Order, Theme } from "@/lib/types";

type View = "store" | "about" | "contact" | "orders" | "faq" | "reviews";

type ToastState = { open: boolean; message: string };

const LS = {
  theme: "nikai_theme",
  lang: "nikai_lang",
  orders: "orders",
} as const;

const i18n = {
  ar: {
    subtitle: "Ù…ØªØ¬Ø± Ù…ØªØ®ØµØµ Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ø±Ù‚Ù…ÙŠÙ‘Ø© â€” Ø§Ø·Ù„Ø¨ Ø§Ø´ØªØ±Ø§ÙƒÙƒ Ø§Ù„Ø¢Ù†",

    menu: "Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©",
    store: "Ø§Ù„Ù…ØªØ¬Ø±",
    about: "Ù…Ù† Ù†Ø­Ù†",
    contactTitle: "ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§",
    orders: "Ø·Ù„Ø¨Ø§ØªÙŠ",
    faq: "Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©",
    reviews: "Ø¢Ø±Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡",

    why: "Ù„Ù…Ø§Ø°Ø§ ØªØ®ØªØ§Ø±Ù†Ø§ØŸ",
    why1: "ğŸš€ ØªÙØ¹ÙŠÙ„ ÙÙˆØ±ÙŠ ÙˆÙ…Ø¶Ù…ÙˆÙ†.",
    why2: "ğŸ“ Ø¯Ø¹Ù… ÙÙ†ÙŠ 24/7.",
    contact: "ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§",

    searchPlaceholder: "Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ø´ØªØ±Ø§Ùƒ...",

    bank: "Ø§Ù„Ø¨Ù†Ùƒ:",
    beneficiary: "Ø§Ù„Ù…Ø³ØªÙÙŠØ¯:",
    copyIban: "Ù†Ø³Ø® Ø§Ù„Ø¢ÙŠØ¨Ø§Ù†",
    confirmOrder: "ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨",
    activationEmail: "Ø¨Ø±ÙŠØ¯ Ø§Ù„ØªÙØ¹ÙŠÙ„:",
    emailPlaceholder: "mail@example.com",
    requiredEmail: "ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ",

    copied: "ØªÙ… Ø§Ù„Ù†Ø³Ø® Ø¨Ù†Ø¬Ø§Ø­ âœ…",

    aboutBody:
      "Ù…ØªØ¬Ø± NIKAI Ù…ØªØ®ØµØµ ÙÙŠ ØªÙˆÙÙŠØ± Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ø±Ù‚Ù…ÙŠØ© Ø¹Ø§Ù„ÙŠØ© Ø§Ù„Ø¬ÙˆØ¯Ø© Ø¨Ø£ÙØ¶Ù„ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±. ÙØ±ÙŠÙ‚Ù†Ø§ Ù…Ù„ØªØ²Ù… Ø¨ØªÙ‚Ø¯ÙŠÙ… Ø£ÙØ¶Ù„ ØªØ¬Ø±Ø¨Ø© Ø¹Ù…Ù„Ø§Ø¡ Ù…Ø¹ Ø¯Ø¹Ù… ÙÙ†ÙŠ Ù…ØªÙˆØ§ØµÙ„.",
    feature1Title: "Ø¬ÙˆØ¯Ø© Ø¹Ø§Ù„ÙŠØ©",
    feature1Body: "Ù…Ù†ØªØ¬Ø§Øª Ù…Ø¹ØªÙ…Ø¯Ø© ÙˆÙ…ÙˆØ«ÙˆÙ‚Ø©",
    feature2Title: "Ø¯Ø¹Ù… 24/7",
    feature2Body: "ÙØ±ÙŠÙ‚ Ø¯Ø¹Ù… Ù…ØªÙˆØ§Ø¬Ø¯ Ø¹Ù„Ù‰ Ù…Ø¯Ø§Ø± Ø§Ù„Ø³Ø§Ø¹Ø©",

    email: "Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ",
    calls: "Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø§Øª",

    footer: "Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Ù„Ù…ØªØ¬Ø± NIKAI Â© 2024",

    statusCompleted: "ØªÙ… Ø§Ù„ØªÙØ¹ÙŠÙ„",
    statusPending: "Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°",

    orderCreated: "ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨",

    ordersTitle: "Ø·Ù„Ø¨Ø§ØªÙƒ (Ù…Ù†ØªØ¬ Ø±Ù‚Ù…ÙŠ â€” Ø¨Ø¯ÙˆÙ† ØªÙˆØµÙŠÙ„)",
    ordersHint:
      "Ù‡Ø°Ø§ Ø³Ø¬Ù„ Ù…Ø­Ù„ÙŠ Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ø¬Ù‡Ø§Ø². Ø¨Ø¹Ø¯ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨ Ø³ÙŠØ¸Ù‡Ø± Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ ÙˆÙŠÙ…ÙƒÙ†Ùƒ Ù†Ø³Ø®Ù‘Ù‡ ÙˆØ§Ù„Ø§Ø³ØªÙØ³Ø§Ø± Ø¹Ù† Ø­Ø§Ù„Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„.",
    noOrders: "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø³Ø§Ø¨Ù‚Ø©",
    clearOrders: "Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„",
    clearConfirm: "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§ØªØŸ",

    orderNumber: "Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨",
    copyOrderNumber: "Ù†Ø³Ø® Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨",
    askWhatsapp: "Ø§Ø³ØªÙØ³Ø§Ø± ÙˆØ§ØªØ³Ø§Ø¨",

    digitalDeliveryNote: "Ø§Ù„Ù…Ù†ØªØ¬ Ø±Ù‚Ù…ÙŠ â€” ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø¨Ø¹Ø¯ Ø§Ù„Ø¯ÙØ¹.",
  },
  en: {
    subtitle: "Digital Subscriptions â€” Order Now",

    menu: "Menu",
    store: "Store",
    about: "About",
    contactTitle: "Contact",
    orders: "My Orders",
    faq: "FAQ",
    reviews: "Reviews",

    why: "Why Us?",
    why1: "ğŸš€ Instant Activation.",
    why2: "ğŸ“ 24/7 Support.",
    contact: "Contact Us",

    searchPlaceholder: "Search subscriptions...",

    bank: "Bank:",
    beneficiary: "Beneficiary:",
    copyIban: "Copy IBAN",
    confirmOrder: "Confirm Order",
    activationEmail: "Activation Email:",
    emailPlaceholder: "mail@example.com",
    requiredEmail: "Please enter email",

    copied: "Copied Successfully âœ…",

    aboutBody:
      "NIKAI provides high-quality digital subscriptions at the best prices. We focus on premium customer experience with continuous support.",
    feature1Title: "High Quality",
    feature1Body: "Trusted, verified subscriptions",
    feature2Title: "24/7 Support",
    feature2Body: "Always available support team",

    email: "Email",
    calls: "Calls",

    footer: "All Rights Reserved to NIKAI STORE Â© 2024",

    statusCompleted: "Activated",
    statusPending: "In progress",

    orderCreated: "Order created",

    ordersTitle: "Your orders (Digital product â€” no shipping)",
    ordersHint:
      "This is a local history on this device. After WhatsApp confirmation, youâ€™ll get an order number you can copy and use for activation status inquiries.",
    noOrders: "No previous orders",
    clearOrders: "Clear history",
    clearConfirm: "Are you sure you want to clear all orders?",

    orderNumber: "Order No.",
    copyOrderNumber: "Copy order no.",
    askWhatsapp: "Ask on WhatsApp",

    digitalDeliveryNote: "Digital product â€” activation details are sent after payment.",
  },
} satisfies Record<Lang, Record<string, string>>;

function formatSar(lang: Lang, value: number) {
  return lang === "ar" ? `${value} Ø±ÙŠØ§Ù„` : `${value} SAR`;
}

function buildOrderWhatsappMessage(
  lang: Lang,
  product: Product,
  planLabel: string,
  priceSar: number,
  orderNumber: string,
  email?: string
) {
  const isAr = lang === "ar";
  const lines = [
    isAr ? "Ø·Ù„Ø¨ Ø§Ø´ØªØ±Ø§Ùƒ Ø±Ù‚Ù…ÙŠ:" : "Digital subscription order:",
    `- ${product.name[lang]}`,
    `${isAr ? "- Ø§Ù„Ø¨Ø§Ù‚Ø©" : "- Plan"}: ${planLabel}`,
    `${isAr ? "- Ø§Ù„Ø³Ø¹Ø±" : "- Price"}: ${priceSar}`,
    `${isAr ? "- Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨" : "- Order No."}: ${orderNumber}`,
  ];
  if (email) lines.push(`${isAr ? "- Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„" : "- Email"}: ${email}`);
  return lines.join("\n");
}

export function App() {
  const [lang, setLang] = useState<Lang>(() => getJSON<Lang>(LS.lang, "ar"));
  const [theme, setTheme] = useState<Theme>(() => getJSON<Theme>(LS.theme, "dark"));
  const [drawerOpen, setDrawerOpen] = useState(false);
  const [view, setView] = useState<View>("store");

  const [query, setQuery] = useState("");

  const [selectedProductId, setSelectedProductId] = useState<string | null>(null);
  const selectedProduct = useMemo(
    () => products.find((p) => p.id === selectedProductId) ?? null,
    [selectedProductId]
  );

  const [selectedPlanIndex, setSelectedPlanIndex] = useState<number>(0);
  const selectedPlan = selectedProduct?.plans[selectedPlanIndex] ?? null;

  const [email, setEmail] = useState("");
  const [toast, setToast] = useState<ToastState>({ open: false, message: "" });

  const [orders, setOrders] = useState<Order[]>(() => migrateOrders(getJSON<unknown>(LS.orders, [])));

  const checkoutRef = useRef<HTMLDivElement | null>(null);

  const t = i18n[lang];

  // Persist + apply document direction/classes
  useEffect(() => {
    document.documentElement.dir = lang === "ar" ? "rtl" : "ltr";
    document.documentElement.lang = lang;
    document.body.classList.toggle("en", lang === "en");
    document.body.classList.toggle("ar", lang === "ar");
    setJSON(LS.lang, lang);
  }, [lang]);

  useEffect(() => {
    document.body.classList.toggle("light-mode", theme === "light");
    setJSON(LS.theme, theme);
  }, [theme]);

  useEffect(() => {
    setJSON(LS.orders, orders);
  }, [orders]);

  // Accent color based on selected product (fallback depends on theme)
  useEffect(() => {
    const fallback = theme === "light" ? "#2563eb" : "#ffffff";
    const accent = selectedProduct?.color ?? fallback;
    document.documentElement.style.setProperty("--accent-color", accent);
    document.documentElement.style.setProperty("--brand-glow", `${accent}44`);
  }, [selectedProduct, theme]);

  // Reset plan/email when switching product
  useEffect(() => {
    setSelectedPlanIndex(0);
    setEmail("");
  }, [selectedProductId]);

  // Scroll to checkout
  useEffect(() => {
    if (selectedProductId && view === "store") {
      window.setTimeout(() => checkoutRef.current?.scrollIntoView({ behavior: "smooth", block: "start" }), 80);
    }
  }, [selectedProductId, view]);

  // Escape to close drawer
  useEffect(() => {
    function onKeyDown(e: KeyboardEvent) {
      if (e.key !== "Escape") return;
      setDrawerOpen(false);
    }
    window.addEventListener("keydown", onKeyDown);
    return () => window.removeEventListener("keydown", onKeyDown);
  }, []);

  function showToast(message: string) {
    setToast({ open: true, message });
    window.setTimeout(() => setToast((s) => ({ ...s, open: false })), 2500);
  }

  async function copyText(value: string, toastMsg?: string) {
    try {
      await navigator.clipboard.writeText(value);
      showToast(toastMsg ?? t.copied);
    } catch {
      const ta = document.createElement("textarea");
      ta.value = value;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      ta.remove();
      showToast(toastMsg ?? t.copied);
    }
  }

  function openDrawer() {
    setDrawerOpen(true);
  }

  function closeDrawer() {
    setDrawerOpen(false);
  }

  function toggleTheme() {
    setTheme((v) => (v === "light" ? "dark" : "light"));
  }

  function toggleLang() {
    setLang((v) => (v === "ar" ? "en" : "ar"));
  }

  function goto(v: View) {
    setView(v);
    closeDrawer();
  }

  function onSelectProduct(id: string) {
    setView("store");
    setSelectedProductId(id);
  }

  function addOrder(productId: string, planLabel: Record<Lang, string>, priceSar: number, customerEmail?: string): Order {
    const orderNumber = generateTrackingCode();
    const now = new Date();

    const order: Order = {
      id: Date.now(),
      trackingCode: orderNumber,
      productId,
      planLabel,
      priceSar,
      status: "pending",
      dateIso: now.toISOString(),
      customerEmail,
      customerType: "guest",
    };

    setOrders((prev) => [order, ...prev]);
    return order;
  }

  function confirmOrder() {
    if (!selectedProduct || !selectedPlan) return;

    const emailValue = email.trim() || undefined;

    if (selectedProduct.needsEmail && !emailValue) {
      showToast(t.requiredEmail);
      return;
    }

    const created = addOrder(selectedProduct.id, selectedPlan.label, selectedPlan.priceSar, emailValue);

    showToast(`${t.orderCreated} â€¢ ${created.trackingCode}`);

    const msg = buildOrderWhatsappMessage(
      lang,
      selectedProduct,
      selectedPlan.label[lang],
      selectedPlan.priceSar,
      created.trackingCode,
      emailValue
    );

    const url = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(msg)}`;
    window.open(url, "_blank");

    setView("orders");
  }

  const filteredProducts = useMemo(() => {
    const q = query.trim().toLowerCase();
    if (!q) return products;
    return products.filter((p) => {
      const name = p.name[lang].toLowerCase();
      return name.includes(q) || p.id.toLowerCase().includes(q);
    });
  }, [query, lang]);

  return (
    <div className="min-h-screen">
      {/* Background */}
      <div className="mesh-container" aria-hidden>
        <div className="blob blob-1" />
        <div className="blob blob-2" />
      </div>

      {/* Overlay */}
      <div className={"overlay " + (drawerOpen ? "show" : "")} onClick={closeDrawer} />

      {/* Toast */}
      <div className={"toast " + (toast.open ? "show" : "")} role="status" aria-live="polite">
        {toast.message}
      </div>

      {/* Top Dock */}
      <div className="glass-dock" role="navigation" aria-label="Quick actions">
        <button
          className="dock-item"
          onClick={toggleTheme}
          aria-label={theme === "light" ? "Switch to dark" : "Switch to light"}
        >
          <i className={theme === "light" ? "fas fa-sun" : "fas fa-moon"} />
        </button>
        <div className="dock-separator" />
        <button className="dock-item" onClick={toggleLang} aria-label="Toggle language">
          <i className="fas fa-language" />
        </button>
        <div className="dock-separator" />
        <button
          className="dock-item"
          onClick={() => setView("orders")}
          aria-label={t.orders}
          title={t.orders}
        >
          <i className="fas fa-receipt" />
        </button>
      </div>

      {/* Menu */}
      <div className="menu-wrapper">
        <button className="menu-btn-glass" onClick={openDrawer} aria-label="Menu">
          <i className="fas fa-bars" />
        </button>
      </div>

      {/* Drawer */}
      <aside className={"drawer " + (drawerOpen ? "open" : "")} aria-label="Drawer">
        <div className="mb-10 flex items-center justify-between">
          <span className="text-sm font-black opacity-60">{t.menu}</span>
          <button onClick={closeDrawer} className="text-xl" aria-label="Close">
            <i className="fas fa-times" />
          </button>
        </div>

        <div
          className={(lang === "ar" ? "border-r-4 pr-4" : "border-l-4 pl-4") + " mb-6"}
          style={{ borderColor: "var(--accent-color)" }}
        >
          <h3 className="text-xl font-black">{t.why}</h3>
        </div>
        <p className="mb-3 text-sm font-semibold">{t.why1}</p>
        <p className="mb-6 text-sm font-semibold">{t.why2}</p>

        <div
          className={(lang === "ar" ? "border-r-4 pr-4" : "border-l-4 pl-4") + " my-10"}
          style={{ borderColor: "var(--accent-color)" }}
        >
          <h3 className="text-xl font-black">{t.contact}</h3>
        </div>

        <a
          href="mailto:iioe@outlook.sa"
          className="mb-4 block text-sm font-bold no-underline"
          style={{ color: "var(--text-main)" }}
        >
          <i className="fas fa-envelope" style={{ color: "var(--accent-color)", marginInlineEnd: 8 }} />
          iioe@outlook.sa
        </a>
        <a href="tel:0591388202" className="block text-sm font-bold no-underline" style={{ color: "var(--text-main)" }}>
          <i className="fas fa-phone" style={{ color: "var(--accent-color)", marginInlineEnd: 8 }} />
          0591388202
        </a>

        <div className="mt-10 grid grid-cols-2 gap-3">
          <button className="glass rounded-2xl px-4 py-3 text-sm font-extrabold" onClick={() => goto("store")}>
            {t.store}
          </button>
          <button className="glass rounded-2xl px-4 py-3 text-sm font-extrabold" onClick={() => goto("orders")}>
            {t.orders}
          </button>
          <button className="glass rounded-2xl px-4 py-3 text-sm font-extrabold" onClick={() => goto("about")}>
            {t.about}
          </button>
          <button className="glass rounded-2xl px-4 py-3 text-sm font-extrabold" onClick={() => goto("contact")}>
            {t.contactTitle}
          </button>
          <button className="glass rounded-2xl px-4 py-3 text-sm font-extrabold" onClick={() => goto("faq")}>
            {t.faq}
          </button>
          <button className="glass rounded-2xl px-4 py-3 text-sm font-extrabold" onClick={() => goto("reviews")}>
            {t.reviews}
          </button>
        </div>
      </aside>

      {/* Content */}
      <div className="mx-auto w-full max-w-[550px] px-5">
        <header className="pt-[100px] pb-10 text-center">
          <h1 className="logo-gradient text-[clamp(38px,12vw,65px)] font-black tracking-[12px] max-[480px]:tracking-[6px]">
            NIKAI
          </h1>
          <p className="mt-2 px-2 text-[13px] font-bold opacity-70">{t.subtitle}</p>
        </header>

        {view === "store" && (
          <main className="pb-14">
            {/* Search */}
            <div className="glass mb-5 flex items-center gap-3 rounded-[20px] px-4 py-3">
              <i className="fas fa-magnifying-glass opacity-70" />
              <input
                value={query}
                onChange={(e) => setQuery(e.target.value)}
                placeholder={t.searchPlaceholder}
                className="w-full bg-transparent py-2 text-sm font-bold outline-none"
                style={{ color: "var(--text-main)" }}
              />
            </div>

            {/* Products Grid */}
            <section>
              <div className="grid grid-cols-3 gap-[14px]">
                {filteredProducts.map((p, i) => {
                  const active = p.id === selectedProductId;
                  return (
                    <button
                      key={p.id}
                      onClick={() => onSelectProduct(p.id)}
                      className={
                        "glass group rounded-[28px] px-2 py-6 text-center transition-all " +
                        "[transition-duration:var(--transition-speed)] " +
                        "hover:-translate-y-2 hover:scale-[1.04]"
                      }
                      style={{
                        transitionTimingFunction: "var(--spring)",
                        transitionDelay: `${i * 0.04}s`,
                        borderColor: active ? "var(--accent-color)" : "var(--card-border)",
                      }}
                    >
                      <i
                        className={p.icon + " mb-3 block text-[32px]"}
                        style={{ color: active ? p.color : "var(--text-main)" }}
                      />
                      <span className="block text-[10px] font-extrabold">{p.name[lang]}</span>
                    </button>
                  );
                })}
              </div>

              {filteredProducts.length === 0 && (
                <div className="mt-6 text-center text-sm font-semibold opacity-70">
                  {lang === "ar" ? "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬." : "No results."}
                </div>
              )}
            </section>

            {/* Checkout */}
            {selectedProduct && selectedPlan && (
              <section ref={checkoutRef} className="mt-8">
                <h2 className="mb-6 text-center text-2xl font-black" style={{ color: "var(--accent-color)" }}>
                  {selectedProduct.name[lang]}
                </h2>

                <div className="grid grid-cols-2 gap-3">
                  {selectedProduct.plans.map((plan, idx) => {
                    const selected = idx === selectedPlanIndex;
                    const isPrivateBadge = Boolean(selectedProduct.isPrivate) && /private|Ø®Ø§Øµ|Ø´Ù‡Ø±|mo/i.test(plan.label[lang]);
                    return (
                      <button
                        key={idx}
                        onClick={() => setSelectedPlanIndex(idx)}
                        className={
                          "relative rounded-[22px] border-2 px-3 py-5 text-center transition-all " +
                          (selected ? "-translate-y-1 text-white" : "")
                        }
                        style={{
                          transitionTimingFunction: "var(--spring)",
                          transitionDuration: "var(--transition-speed)",
                          borderColor: selected ? selectedProduct.color : "var(--card-border)",
                          background: selected ? selectedProduct.color : "var(--card-bg)",
                          boxShadow: selected ? "0 10px 20px var(--brand-glow)" : "none",
                        }}
                      >
                        {isPrivateBadge && (
                          <span className="absolute left-2 top-2 rounded-full bg-white px-2 py-1 text-[8px] font-black text-black">
                            {lang === "ar" ? "Ø®Ø§Øµ" : "Private"}
                          </span>
                        )}
                        <span className="block text-xs font-extrabold">{plan.label[lang]}</span>
                        <strong className="mt-1 block text-sm">{formatSar(lang, plan.priceSar)}</strong>
                      </button>
                    );
                  })}
                </div>

                {selectedProduct.needsEmail && (
                  <div className="mt-7">
                    <label className="mb-3 block text-center text-sm font-black opacity-70">{t.activationEmail}</label>
                    <input
                      value={email}
                      onChange={(e) => setEmail(e.target.value)}
                      type="email"
                      placeholder={t.emailPlaceholder}
                      className="glass w-full rounded-[20px] border px-5 py-4 text-center font-bold outline-none"
                      style={{ borderColor: "var(--card-border)" }}
                    />
                  </div>
                )}

                <div className="glass mt-7 overflow-hidden rounded-[35px] p-6">
                  <div className="mb-4 flex items-center justify-between text-sm font-bold">
                    <span className="opacity-80">{t.bank}</span>
                    <span>Ø¨Ù†Ùƒ Ø§Ù„Ø¨Ù„Ø§Ø¯</span>
                  </div>
                  <div className="mb-4 flex items-center justify-between text-sm font-bold">
                    <span className="opacity-80">{t.beneficiary}</span>
                    <span>Ø³Ù„ÙŠÙ…Ø§Ù† ÙÙ„Ø§ØªÙ‡</span>
                  </div>

                  <div className="my-5 overflow-hidden rounded-[18px] border" style={{ borderColor: "var(--card-border)" }}>
                    <div className="px-4 py-3" style={{ background: "rgba(0,0,0,0.1)" }}>
                      <span className="select-all font-bold" dir="ltr">
                        {IBAN}
                      </span>
                    </div>
                    <button
                      onClick={() => copyText(IBAN, t.copied)}
                      className="w-full px-4 py-4 text-center font-bold text-white"
                      style={{ background: "var(--accent-color)" }}
                    >
                      <i className="fas fa-copy" /> {t.copyIban}
                    </button>
                  </div>

                  <div className="text-center text-xs font-bold opacity-70">{t.digitalDeliveryNote}</div>

                  <button
                    onClick={confirmOrder}
                    className="mt-4 w-full rounded-[25px] px-5 py-5 text-lg font-black text-white"
                    style={{ background: "#25d366", boxShadow: "0 10px 20px rgba(37, 211, 102, 0.2)" }}
                  >
                    <i className="fab fa-whatsapp" /> {t.confirmOrder}
                  </button>
                </div>

                {/* Quick links */}
                <div className="mt-6 grid grid-cols-2 gap-3">
                  <button
                    className="glass rounded-[18px] px-4 py-4 text-sm font-black"
                    style={{ color: "var(--text-main)" }}
                    onClick={() => setView("orders")}
                  >
                    <i className="fas fa-receipt" style={{ color: "var(--accent-color)", marginInlineEnd: 8 }} />
                    {t.orders}
                  </button>
                  <button
                    className="glass rounded-[18px] px-4 py-4 text-sm font-black"
                    style={{ color: "var(--text-main)" }}
                    onClick={() => setView("faq")}
                  >
                    <i className="fas fa-circle-question" style={{ color: "var(--accent-color)", marginInlineEnd: 8 }} />
                    {t.faq}
                  </button>
                </div>
              </section>
            )}

            {/* Store extras */}
            <section className="mt-10">
              <div className="grid grid-cols-2 gap-3">
                <button className="glass rounded-[18px] px-4 py-4 text-sm font-black" onClick={() => setView("reviews")}>
                  <i className="fas fa-star" style={{ color: "var(--accent-color)", marginInlineEnd: 8 }} />
                  {t.reviews}
                </button>
                <button className="glass rounded-[18px] px-4 py-4 text-sm font-black" onClick={() => setView("contact")}>
                  <i className="fas fa-headset" style={{ color: "var(--accent-color)", marginInlineEnd: 8 }} />
                  {t.contactTitle}
                </button>
              </div>
            </section>
          </main>
        )}

        {view === "orders" && (
          <section className="pb-14">
            <h2 className="mb-2 text-center text-2xl font-black" style={{ color: "var(--accent-color)" }}>
              {t.ordersTitle}
            </h2>
            <p className="mb-6 text-center text-sm font-semibold opacity-70">{t.ordersHint}</p>

            <div className="mb-5 flex items-center justify-between">
              <div className="text-xs font-black opacity-70">{t.digitalDeliveryNote}</div>
              <button
                className="rounded-[12px] px-3 py-2 text-xs font-black text-white"
                style={{ background: "rgba(239, 68, 68, 0.85)" }}
                onClick={() => {
                  if (!orders.length) return;
                  if (confirm(t.clearConfirm)) {
                    setOrders([]);
                    showToast(lang === "ar" ? "ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„" : "History cleared");
                  }
                }}
              >
                {t.clearOrders}
              </button>
            </div>

            {orders.length === 0 && (
              <div className="glass rounded-[20px] p-5 text-center">
                <p className="text-sm opacity-80">{t.noOrders}</p>
              </div>
            )}

            {orders.length > 0 && (
              <div className="space-y-4">
                {orders.map((order) => {
                  const product = products.find((p) => p.id === order.productId);
                  const statusText = order.status === "completed" ? t.statusCompleted : t.statusPending;
                  const statusStyle =
                    order.status === "completed"
                      ? { background: "rgba(0, 128, 0, 0.1)", color: "#008000" }
                      : { background: "rgba(255, 165, 0, 0.1)", color: "#FFA500" };

                  const inquiryText =
                    lang === "ar"
                      ? `Ø§Ø³ØªÙØ³Ø§Ø± Ø¹Ù† Ø·Ù„Ø¨ Ø§Ø´ØªØ±Ø§Ùƒ Ø±Ù‚Ù…ÙŠ\nØ±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: ${order.trackingCode}`
                      : `Inquiry about digital subscription order\nOrder No.: ${order.trackingCode}`;

                  return (
                    <details key={order.id} className="glass rounded-[20px] p-5">
                      <summary className="cursor-pointer list-none">
                        <div className="flex items-start justify-between gap-3">
                          <div>
                            <div className="font-black">{product?.name[lang] ?? order.productId}</div>
                            <div className="mt-1 text-sm font-semibold opacity-80">
                              {order.planLabel[lang]} â€¢ {formatSar(lang, order.priceSar)}
                            </div>
                          </div>
                          <div className="rounded-full px-3 py-1 text-[12px] font-bold" style={statusStyle}>
                            {statusText}
                          </div>
                        </div>
                      </summary>

                      <div className="mt-4 text-sm font-semibold opacity-90">
                        <div>
                          {lang === "ar" ? "Ø§Ù„ØªØ§Ø±ÙŠØ®" : "Date"}: {new Date(order.dateIso).toLocaleDateString()}
                        </div>
                        <div className="mt-3 flex items-center justify-between gap-3 rounded-[14px] border px-3 py-3" style={{ borderColor: "var(--card-border)" }}>
                          <div className="text-xs font-black opacity-70">{t.orderNumber}</div>
                          <div className="select-all text-sm font-black" dir="ltr">
                            {order.trackingCode}
                          </div>
                        </div>
                      </div>

                      <div className="mt-4 grid grid-cols-2 gap-3">
                        <button
                          className="rounded-[15px] px-4 py-4 text-sm font-black text-white"
                          style={{ background: "var(--accent-color)" }}
                          onClick={() => copyText(order.trackingCode, t.copied)}
                        >
                          <i className="fas fa-copy" /> {t.copyOrderNumber}
                        </button>
                        <a
                          className="glass flex items-center justify-center gap-2 rounded-[15px] px-4 py-4 text-sm font-black no-underline"
                          style={{ color: "var(--text-main)" }}
                          href={`https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(inquiryText)}`}
                          target="_blank"
                          rel="noreferrer"
                        >
                          <i className="fab fa-whatsapp" style={{ color: "#25d366" }} />
                          {t.askWhatsapp}
                        </a>
                      </div>

                      {order.customerEmail && (
                        <div className="mt-3 text-xs font-bold opacity-70" dir="ltr">
                          {order.customerEmail}
                        </div>
                      )}
                    </details>
                  );
                })}
              </div>
            )}

            <div className="mt-8 grid grid-cols-2 gap-3">
              <button className="glass rounded-[18px] px-4 py-4 text-sm font-black" onClick={() => setView("store")}>
                <i className="fas fa-store" style={{ color: "var(--accent-color)", marginInlineEnd: 8 }} />
                {t.store}
              </button>
              <button className="glass rounded-[18px] px-4 py-4 text-sm font-black" onClick={() => setView("contact")}>
                <i className="fas fa-headset" style={{ color: "var(--accent-color)", marginInlineEnd: 8 }} />
                {t.contactTitle}
              </button>
            </div>
          </section>
        )}

        {view === "faq" && (
          <section className="pb-14">
            <h2 className="mb-6 text-center text-2xl font-black" style={{ color: "var(--accent-color)" }}>
              {t.faq}
            </h2>

            <div className="space-y-3">
              {faq.map((item, idx) => (
                <details key={idx} className="glass rounded-[20px] p-5">
                  <summary className="cursor-pointer list-none text-sm font-black">
                    <div className="flex items-center justify-between gap-3">
                      <span>{item.q[lang]}</span>
                      <i className="fas fa-chevron-down opacity-70" />
                    </div>
                  </summary>
                  <p className="mt-3 text-sm font-semibold opacity-85">{item.a[lang]}</p>
                </details>
              ))}
            </div>
          </section>
        )}

        {view === "reviews" && (
          <section className="pb-14">
            <h2 className="mb-6 text-center text-2xl font-black" style={{ color: "var(--accent-color)" }}>
              {t.reviews}
            </h2>

            <div className="space-y-4">
              {testimonials.map((r, idx) => (
                <div key={idx} className="glass rounded-[20px] p-5">
                  <div className="mb-2 text-sm" style={{ color: "#FFD700" }}>
                    {"â˜…â˜…â˜…â˜…â˜…".slice(0, r.rating)}
                  </div>
                  <p className="text-sm font-semibold opacity-90">â€œ{r.text[lang]}â€</p>
                  <div className="mt-3 text-sm font-black opacity-80">{r.name}</div>
                </div>
              ))}
            </div>
          </section>
        )}

        {view === "about" && (
          <section className="pb-14">
            <h2 className="mb-6 text-center text-2xl font-black" style={{ color: "var(--accent-color)" }}>
              {t.about}
            </h2>
            <p className="glass rounded-[25px] p-5 text-sm font-semibold opacity-90">{t.aboutBody}</p>

            <div className="mt-6 grid grid-cols-2 gap-5">
              <div className="glass rounded-[20px] p-5 text-center">
                <i className="fas fa-medal mb-2 text-[32px]" style={{ color: "var(--accent-color)" }} />
                <h4 className="font-black">{t.feature1Title}</h4>
                <p className="mt-1 text-sm opacity-80">{t.feature1Body}</p>
              </div>
              <div className="glass rounded-[20px] p-5 text-center">
                <i className="fas fa-headset mb-2 text-[32px]" style={{ color: "var(--accent-color)" }} />
                <h4 className="font-black">{t.feature2Title}</h4>
                <p className="mt-1 text-sm opacity-80">{t.feature2Body}</p>
              </div>
            </div>
          </section>
        )}

        {view === "contact" && (
          <section className="pb-14">
            <h2 className="mb-6 text-center text-2xl font-black" style={{ color: "var(--accent-color)" }}>
              {t.contactTitle}
            </h2>

            <div className="glass rounded-[35px] p-5">
              <div className="mb-3 flex items-center justify-between text-sm font-bold">
                <span className="opacity-80">{t.bank}</span>
                <span>Ø¨Ù†Ùƒ Ø§Ù„Ø¨Ù„Ø§Ø¯</span>
              </div>
              <div className="mb-3 flex items-center justify-between text-sm font-bold">
                <span className="opacity-80">{t.beneficiary}</span>
                <span>Ø³Ù„ÙŠÙ…Ø§Ù† ÙÙ„Ø§ØªÙ‡</span>
              </div>

              <div className="my-5 overflow-hidden rounded-[18px] border" style={{ borderColor: "var(--card-border)" }}>
                <div className="px-4 py-3" style={{ background: "rgba(0,0,0,0.1)" }}>
                  <span className="select-all font-bold" dir="ltr">
                    {IBAN}
                  </span>
                </div>
              </div>

              <div className="mt-5 grid grid-cols-2 gap-3">
                <a
                  className="glass flex items-center justify-center gap-2 rounded-[15px] p-4 text-sm font-bold no-underline"
                  href="mailto:iioe@outlook.sa"
                  style={{ color: "var(--text-main)" }}
                >
                  <i className="fas fa-envelope" style={{ color: "var(--accent-color)" }} />
                  {t.email}
                </a>
                <a
                  className="glass flex items-center justify-center gap-2 rounded-[15px] p-4 text-sm font-bold no-underline"
                  href="tel:0591388202"
                  style={{ color: "var(--text-main)" }}
                >
                  <i className="fas fa-phone" style={{ color: "var(--accent-color)" }} />
                  {t.calls}
                </a>
              </div>

              <a
                className="mt-4 flex items-center justify-center gap-2 rounded-[18px] px-4 py-4 text-sm font-black text-white no-underline"
                style={{ background: "#25d366" }}
                href={`https://wa.me/${WHATSAPP_NUMBER}`}
                target="_blank"
                rel="noreferrer"
              >
                <i className="fab fa-whatsapp" /> WhatsApp
              </a>
            </div>
          </section>
        )}

        <footer className="border-t py-12 text-center text-[11px] opacity-60" style={{ borderColor: "var(--card-border)" }}>
          {t.footer}
        </footer>
      </div>
    </div>
  );
}